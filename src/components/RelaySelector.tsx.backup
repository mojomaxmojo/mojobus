import { useState, useEffect } from "react";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Label } from "@/components/ui/label";
import { RELAY_PRESETS, DEFAULT_APP_CONFIG } from "@/config";
import { useNostr } from "@nostrify/react";

interface PresetOption {
value: string;
label: string;
description: string;
}

const PRESET_OPTIONS: PresetOption[] = [
{
value: "fast",
label: "Fast",
description: "Schnelle Ladezeiten, minimale Latency",
},
{
value: "balanced",
label: "Balanced",
description: "Ausgewogene Performance und Zuverlässigkeit",
},
{
value: "reliable",
label: "Reliable",
description: "Maximale Zuverlässigkeit mit mehreren Relays",
},
];

export function RelaySelector() {
const { nostr } = useNostr();
const [selectedPreset, setSelectedPreset] = useState<string>("fast");
const [customRelays, setCustomRelays] = useState<string[]>([]);
const [autoApply, setAutoApply] = useState<boolean>(true);

const applyPreset = async (preset: string) => {
const presetConfig = RELAY_PRESETS[preset as keyof typeof RELAY_PRESETS];

if (presetConfig) {
try {
const currentRelays = nostr.getRelays();
const newRelays = presetConfig.relayUrls;

console.log("Replacing relays...");
console.log("Current:", currentRelays);
console.log("New:", newRelays);

currentRelays.forEach(relay => {
nostr.removeRelay(relay.url);
});

newRelays.forEach(url => {
nostr.addRelay({ url, read: true, write: true });
});

localStorage.setItem("nostr:app-config", JSON.stringify({
...JSON.parse(localStorage.getItem("nostr:app-config") || "{}"),
relayUrls: newRelays,
activeRelay: newRelays[0],
maxRelays: presetConfig.maxRelays,
queryTimeout: presetConfig.queryTimeout,
preset: preset,
}));

setSelectedPreset(preset);
} catch (error) {
console.error("Failed to apply preset:", error);
}
}
};

const handlePresetChange = (preset: string) => {
setSelectedPreset(preset);
if (autoApply) {
applyPreset(preset);
}
};

return (
<div className="space-y-6">
<div>
<h3 className="text-lg font-semibold mb-4">Relay-Preset wählen</h3>
<p className="text-sm text-muted-foreground mb-6">
Wähle einen Relay-Preset für optimale Performance
</p>
</div>

<div>
<Label htmlFor="relay-preset">Relay-Preset wählen</Label>
<Select value={selectedPreset} onValueChange={handlePresetChange}>
<SelectTrigger id="relay-preset">
<SelectValue placeholder="Preset wählen..." />
</SelectTrigger>
<SelectContent>
{PRESET_OPTIONS.map((option) => (
<SelectItem key={option.value} value={option.value}>
<div className="flex flex-col">
<span className="font-medium">{option.label}</span>
<span className="text-xs text-muted-foreground">
{option.description}
</span>
</div>
</SelectItem>
))}
</SelectContent>
</Select>
</div>
<p className="text-xs text-muted-foreground">
Automatische Anpassung aller Relay-Einstellungen
</p>

<div className="space-y-2">
<label className="flex items-center space-x-2">
<input
type="checkbox"
checked={autoApply}
onChange={(e) => setAutoApply(e.target.checked)}
className="h-4 w-4"
/>
<span className="text-sm">Preset automatisch anwenden</span>
</label>
</div>

{selectedPreset && (
<div className="bg-muted/50 rounded-lg p-4 space-y-3">
<h4 className="text-sm font-medium mb-2">Gewähltes Preset: {selectedPreset}</h4>
<div className="text-xs text-muted-foreground">
{PRESET_OPTIONS.find(o => o.value === selectedPreset)?.description}
</div>

<div className="grid grid-cols-2 gap-4 text-xs">
<div>
<span className="font-medium">Relays:</span>
<div className="text-muted-foreground">
{RELAY_PRESETS[selectedPreset as keyof typeof RELAY_PRESETS]?.relayUrls.join(", ") || "-"}
</div>
</div>
<div>
<span className="font-medium">Max Relays:</span>
<div className="text-muted-foreground">
{RELAY_PRESETS[selectedPreset as keyof typeof RELAY_PRESETS]?.maxRelays || "-"}
</div>
</div>
<div>
<span className="font-medium">Timeout:</span>
<div className="text-muted-foreground">
{RELAY_PRESETS[selectedPreset as keyof typeof RELAY_PRESETS]?.queryTimeout ? `${RELAY_PRESETS[selectedPreset as keyof typeof RELAY_PRESETS].queryTimeout / 1000}s` : "-"} ms
</div>
</div>
<div>
<span className="font-medium">Deduplizierung:</span>
<div className="text-muted-foreground">
{RELAY_PRESETS[selectedPreset as keyof typeof RELAY_PRESETS]?.enableDeduplication ? "Aktiv" : "Inaktiv"}
</div>
</div>
</div>
</div>
)}
</div>
);
}
